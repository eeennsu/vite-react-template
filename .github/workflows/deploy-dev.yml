name: Deploy to Amazon ECR

on:
  push:
    branches: ['dev', 'beta', 'main']

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: vite-react-template
  COMMIT_AUTHOR: ${{ github.event.head_commit.author.name || github.actor }}

permissions:
  contents: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Determine environment
        run: |
          BRANCH_NAME=${{ github.ref_name }}
          if [ "$BRANCH_NAME" == "dev" ]; then
            echo "BUILD_ENV=development" >> $GITHUB_ENV
            echo "NOTIFY_PREFIX=DEV" >> $GITHUB_ENV
          elif [ "$BRANCH_NAME" == "beta" ]; then
            echo "BUILD_ENV=beta" >> $GITHUB_ENV
            echo "NOTIFY_PREFIX=BETA" >> $GITHUB_ENV
          elif [ "$BRANCH_NAME" == "main" ]; then
            echo "BUILD_ENV=production" >> $GITHUB_ENV
            echo "NOTIFY_PREFIX=PROD" >> $GITHUB_ENV
          fi

      # === Kakao: START ===
      - name: KakaoTalk - Notify START
        id: kakao-start
        env:
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          KAKAO_REFRESH_TOKEN: ${{ secrets.KAKAO_REFRESH_TOKEN }}
        run: |
          START_TS=$(date +%s)
          ACCESS_TOKEN=$(curl -s -X POST https://kauth.kakao.com/oauth/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=refresh_token&client_id=${KAKAO_REST_API_KEY}&refresh_token=${KAKAO_REFRESH_TOKEN}" | jq -r '.access_token')
          if [ -z "${ACCESS_TOKEN}" ] || [ "${ACCESS_TOKEN}" = "null" ]; then
            echo "Failed to get Kakao access token"; exit 1
          fi
          { echo "ACCESS_TOKEN=${ACCESS_TOKEN}"; echo "START_TS=${START_TS}"; } >> "$GITHUB_OUTPUT"

          TEMPLATE=$(jq -nc \
              --arg prefix "$NOTIFY_PREFIX" --arg repo "$GITHUB_REPOSITORY" \
              --arg branch "$GITHUB_REF_NAME" --arg commit "${GITHUB_SHA::7}" \
              --arg author "$COMMIT_AUTHOR" \
              '{object_type:"text", text:("[" + $prefix + "]" + " ðŸš€ ë°°í¬ ì‹œìž‘" + "\në ˆí¬ì§€í† ë¦¬: " + $repo + "\në¸Œëžœì¹˜: " + $branch + "\nì»¤ë°‹: " + $commit + "\nìž‘ì„±ìž: " + $author), link:{web_url:"https://github.com/'"${GITHUB_REPOSITORY}"'/actions/runs/'"${GITHUB_RUN_ID}"'"}, button_title:"ìžì„¸ížˆ"}')

          curl -s -X POST "https://kapi.kakao.com/v2/api/talk/memo/default/send" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            --data-urlencode "template_object=${TEMPLATE}" >/dev/null

      # dev í™˜ê²½ìš© ë²„ì „ íƒœê·¸ ìƒì„±
      - name: Generate development/beta version tag
        if: env.BUILD_ENV == 'development'
        run: |
          DATETIME=$(date +'%Y%m%d-%H%M%S')
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "VERSION=${DATETIME}-${COMMIT_HASH}" >> $GITHUB_ENV

      # beta í™˜ê²½ìš© ë²„ì „ íƒœê·¸ ìƒì„±
      - name: Generate development/beta version tag
        if: env.BUILD_ENV == 'beta'
        run: |
          DATETIME=$(date +'%Y%m%d-%H%M%S')
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "VERSION=${DATETIME}-${COMMIT_HASH}" >> $GITHUB_ENV

      # production í™˜ê²½ìš© ì‹œë§¨í‹± ë²„ì „ íƒœê·¸ ìƒì„±
      - name: Generate production version tag
        if: env.BUILD_ENV == 'production'
        run: |
          git fetch --tags
          LATEST_TAG=$(git tag -l "v*.*.*" | sort -V | tail -n 1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0"
          fi
          echo "Latest tag found: $LATEST_TAG"

          MAJOR=$(echo $LATEST_TAG | cut -d. -f1 | cut -dv -f2)
          MINOR=$(echo $LATEST_TAG | cut -d. -f2)
          PATCH=$(echo $LATEST_TAG | cut -d. -f3)

          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="v$MAJOR.$MINOR.$NEW_PATCH"
          echo "New version will be: $NEW_VERSION"
          echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a $NEW_VERSION -m "Release $NEW_VERSION"
          git push origin $NEW_VERSION

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build-push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.BUILD_ENV }}-${{ env.VERSION }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.BUILD_ENV }}-latest

      # === Kakao: SUCCESS ===
      - name: KakaoTalk - Notify SUCCESS
        if: ${{ success() }}
        env:
          ACCESS_TOKEN: ${{ steps.kakao-start.outputs.ACCESS_TOKEN }}
          START_TS: ${{ steps.kakao-start.outputs.START_TS }}
        run: |
          END_TS=$(date +%s)
          ELAPSED=$(( END_TS - START_TS ))
          DURATION=$(printf "%dm %02ds" "$(( ELAPSED / 60 ))" "$(( ELAPSED % 60 ))")
          IMAGE="${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.VERSION }}"

          TEMPLATE=$(jq -nc \
              --arg prefix "$NOTIFY_PREFIX" \
              --arg repo "$GITHUB_REPOSITORY" --arg branch "$GITHUB_REF_NAME" \
              --arg commit "${GITHUB_SHA::7}" --arg author "$COMMIT_AUTHOR" \
              --arg img "$IMAGE" --arg run "$GITHUB_RUN_NUMBER" --arg dur "$DURATION" \
              '{object_type:"text", text:("[" + $prefix + "]" + " âœ…  ë°°í¬ ì„±ê³µ" + "\në ˆí¬ì§€í† ë¦¬: " + $repo + "\në¸Œëžœì¹˜: " + $branch + "\nì»¤ë°‹: " + $commit + "\nìž‘ì„±ìž: " + $author + "\nì´ë¯¸ì§€: " + $img + "\nrun: " + $run + "\nâ± ê²½ê³¼: " + $dur), link:{web_url:"https://github.com/'"${GITHUB_REPOSITORY}"'/actions/runs/'"${GITHUB_RUN_ID}"'"}, button_title:"ë¡œê·¸ ë³´ê¸°"}')

          curl -s -X POST "https://kapi.kakao.com/v2/api/talk/memo/default/send" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            --data-urlencode "template_object=${TEMPLATE}" >/dev/null

      # === Kakao: FAILURE ===
      - name: KakaoTalk - Notify FAILURE
        if: ${{ failure() }}
        env:
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          KAKAO_REFRESH_TOKEN: ${{ secrets.KAKAO_REFRESH_TOKEN }}
          START_TS: ${{ steps.kakao-start.outputs.START_TS }}
        run: |
          ACCESS_TOKEN=$(curl -s -X POST https://kauth.kakao.com/oauth/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=refresh_token&client_id=${KAKAO_REST_API_KEY}&refresh_token=${KAKAO_REFRESH_TOKEN}" | jq -r '.access_token')
          END_TS=$(date +%s)
          ELAPSED=$(( END_TS - START_TS ))
          DURATION=$(printf "%dm %02ds" "$(( ELAPSED / 60 ))" "$(( ELAPSED % 60 ))")

          TEMPLATE=$(jq -nc \
              --arg prefix "$NOTIFY_PREFIX" \
              --arg repo "$GITHUB_REPOSITORY" --arg branch "$GITHUB_REF_NAME" \
              --arg commit "${GITHUB_SHA::7}" --arg author "$COMMIT_AUTHOR" \
              --arg dur "$DURATION" \
              '{object_type:"text", text:("[" + $prefix + "]" + " âŒ ë°°í¬ ì‹¤íŒ¨" + "\në ˆí¬ì§€í† ë¦¬: " + $repo + "\në¸Œëžœì¹˜: " + $branch + "\nì»¤ë°‹: " + $commit + "\nìž‘ì„±ìž: " + $author + "\nâ± ê²½ê³¼: " + $dur), link:{web_url:"https://github.com/'"${GITHUB_REPOSITORY}"'/actions/runs/'"${GITHUB_RUN_ID}"'"}, button_title:"ì—ëŸ¬ ë¡œê·¸"}')

          curl -s -X POST "https://kapi.kakao.com/v2/api/talk/memo/default/send" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            --data-urlencode "template_object=${TEMPLATE}" >/dev/null
