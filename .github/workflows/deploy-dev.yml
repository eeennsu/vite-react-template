name: Build and Push to ECR on dev push

# dev ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì‹¤í–‰ë˜ë„ë¡ ìˆ˜ì •
on:
  push:
    branches:
      - 'dev'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      AWS_REGION: ap-northeast-2
      ECR_REPOSITORY: vite-react-template

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # =========================================================
      # 1. ë°°í¬ ì‹œì‘ ì•Œë¦¼
      # =========================================================
      - name: Get Access Token for Start Notification
        id: get_token_start
        run: |
          response=$(curl -s -X POST "https://kauth.kakao.com/oauth/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=refresh_token" \
            -d "client_id=${{ secrets.KAKAO_REST_API_KEY }}" \
            -d "refresh_token=${{ secrets.KAKAO_REFRESH_TOKEN }}")
          echo "access_token=$(echo $response | jq -r .access_token)" >> $GITHUB_OUTPUT

      - name: Send KakaoTalk message on start
        uses: StyleShare/action-kakao-talk@v1
        with:
          token: ${{ steps.get_token_start.outputs.access_token }}
          template: |
            {
              "object_type": "text",
              "text": "ğŸš€ [${{ env.ECR_REPOSITORY }}] ë°°í¬ ì‹œì‘\n- Branch: ${{ github.ref_name }}\n- Commit: ${{ github.sha }}",
              "link": {
                "web_url": "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}",
                "mobile_web_url": "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
              },
              "button_title": "ì»¤ë°‹ ë‚´ì—­ í™•ì¸í•˜ê¸°"
            }

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build-image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:dev-${{ github.sha }}, ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest
        env:
          IMAGE_VERSION: $(date +'%Y%d%m-%H%M%S')-${{ github.sha }}

      # =========================================================
      # 2. ë°°í¬ ì„±ê³µ ì•Œë¦¼
      # =========================================================
      - name: Get Access Token for Success Notification
        if: success()
        id: get_token_success
        run: |
          response=$(curl -s -X POST "https://kauth.kakao.com/oauth/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=refresh_token" \
            -d "client_id=${{ secrets.KAKAO_REST_API_KEY }}" \
            -d "refresh_token=${{ secrets.KAKAO_REFRESH_TOKEN }}")
          echo "access_token=$(echo $response | jq -r .access_token)" >> $GITHUB_OUTPUT

      - name: Send KakaoTalk message on success
        if: success()
        uses: StyleShare/action-kakao-talk@v1
        with:
          token: ${{ steps.get_token_success.outputs.access_token }}
          template: |
            {
              "object_type": "text",
              "text": "âœ… [${{ env.ECR_REPOSITORY }}] ë°°í¬ ì„±ê³µ!\n- Image Digest: ${{ steps.build-image.outputs.digest }}",
              "link": {
                "web_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "mobile_web_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              },
              "button_title": "Actions ë¡œê·¸ ë³´ê¸°"
            }

      # =========================================================
      # 3. ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
      # =========================================================
      - name: Get Access Token for Failure Notification
        if: failure()
        id: get_token_failure
        run: |
          response=$(curl -s -X POST "https://kauth.kakao.com/oauth/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=refresh_token" \
            -d "client_id=${{ secrets.KAKAO_REST_API_KEY }}" \
            -d "refresh_token=${{ secrets.KAKAO_REFRESH_TOKEN }}")
          echo "access_token=$(echo $response | jq -r .access_token)" >> $GITHUB_OUTPUT

      - name: Send KakaoTalk message on failure
        if: failure()
        uses: StyleShare/action-kakao-talk@v1
        with:
          token: ${{ steps.get_token_failure.outputs.access_token }}
          template: |
            {
              "object_type": "text",
              "text": "âŒ [${{ env.ECR_REPOSITORY }}] ë°°í¬ ì‹¤íŒ¨...\n- Branch: ${{ github.ref_name }}\n- í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.",
              "link": {
                "web_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "mobile_web_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              },
              "button_title": "Actions ë¡œê·¸ ë³´ê¸°"
            }
