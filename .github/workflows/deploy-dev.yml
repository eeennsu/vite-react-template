name: Build and Push to ECR on dev push

on:
  push:
    branches:
      - 'dev'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      AWS_REGION: ap-northeast-2
      ECR_REPOSITORY: vite-react-template

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # =========================================================
      # âœ… 1. ë°°í¬ ì‹œì‘ ì•Œë¦¼
      # =========================================================
      - name: Send KakaoTalk message on start
        uses: jun-choi/action-kakao-message@v1
        with:
          bot-token: ${{ secrets.KAKAO_REST_API_KEY }}
          refresh-token: ${{ secrets.KAKAO_REFRESH_TOKEN }}
          text: |
            ğŸš€ [${{ env.ECR_REPOSITORY }}] ë°°í¬ ì‹œì‘
            - Branch: ${{ github.ref_name }}
            - Commit: ${{ github.sha }}
            - Written by: ${{ github.actor }}
          button-text: 'ì»¤ë°‹ ë‚´ì—­ í™•ì¸í•˜ê¸°'
          button-url: '${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build-image # stepì— idë¥¼ ë¶€ì—¬í•˜ì—¬ ê²°ê³¼ ì ‘ê·¼
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:dev-${{ github.sha }}, ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest
        env:
          IMAGE_VERSION: $(date +'%Y%d%m-%H%M%S')-${{ github.sha }}

      # =========================================================
      # âœ… 2. ë°°í¬ ì„±ê³µ ì•Œë¦¼ (ëª¨ë“  ìŠ¤í…ì´ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰)
      # =========================================================
      - name: Send KakaoTalk message on success
        if: success()
        uses: jun-choi/action-kakao-message@v1
        with:
          bot-token: ${{ secrets.KAKAO_REST_API_KEY }}
          refresh-token: ${{ secrets.KAKAO_REFRESH_TOKEN }}
          text: |
            âœ… [${{ env.ECR_REPOSITORY }}] ë°°í¬ ì„±ê³µ
            - Image Digest: ${{ steps.build-image.outputs.digest }}
          button-text: 'Actions ë¡œê·¸ ë³´ê¸°'
          button-url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'

      # =========================================================
      # âœ… 3. ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼ (í•˜ë‚˜ë¼ë„ ìŠ¤í…ì´ ì‹¤íŒ¨í–ˆì„ ë•Œ ì‹¤í–‰)
      # =========================================================
      - name: Send KakaoTalk message on failure
        if: failure()
        uses: jun-choi/action-kakao-message@v1
        with:
          bot-token: ${{ secrets.KAKAO_REST_API_KEY }}
          refresh-token: ${{ secrets.KAKAO_REFRESH_TOKEN }}
          text: |
            âŒ [${{ env.ECR_REPOSITORY }}] ë°°í¬ ì‹¤íŒ¨
            - Branch: ${{ github.ref_name }}
            - í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
          button-text: 'Actions ë¡œê·¸ ë³´ê¸°'
          button-url: '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
