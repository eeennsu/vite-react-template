name: Build and Push to ECR on dev push

on:
  push:
    branches: ['dev']

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      AWS_REGION: ap-northeast-2
      ECR_REPOSITORY: vite-react-template

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # === Kakao: START ===
      - name: KakaoTalk - Notify START
        id: kakao-start
        env:
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          KAKAO_REFRESH_TOKEN: ${{ secrets.KAKAO_REFRESH_TOKEN }}
        run: |
          ACCESS_TOKEN=$(curl -s -X POST https://kauth.kakao.com/oauth/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=refresh_token&client_id=${KAKAO_REST_API_KEY}&refresh_token=${KAKAO_REFRESH_TOKEN}" \
            | jq -r '.access_token')

          if [ -z "${ACCESS_TOKEN}" ] || [ "${ACCESS_TOKEN}" = "null" ]; then
            echo "Failed to get Kakao access token"; exit 1
          fi
          echo "ACCESS_TOKEN=${ACCESS_TOKEN}" >> $GITHUB_OUTPUT

          MSG_TITLE="ðŸš€ DEV ë°°í¬ ì‹œìž‘"
          MSG_DESC="repo: ${GITHUB_REPOSITORY}\nbranch: ${GITHUB_REF_NAME}\ncommit: ${GITHUB_SHA::7}"
          TEMPLATE=$(jq -nc --arg t "$MSG_TITLE" --arg d "$MSG_DESC" \
            '{object_type:"text", text:($t+"\n"+$d), link:{web_url:"https://github.com/'"${GITHUB_REPOSITORY}"'/actions/runs/'"${GITHUB_RUN_ID}"'", mobile_web_url:"https://github.com/'"${GITHUB_REPOSITORY}"'/actions/runs/'"${GITHUB_RUN_ID}"'"}, button_title:"ìžì„¸ížˆ"}')

          curl -s -X POST "https://kapi.kakao.com/v2/api/talk/memo/default/send" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            --data-urlencode "template_object=${TEMPLATE}" >/dev/null

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build-push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:dev-${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest

      # === Kakao: SUCCESS ===
      - name: KakaoTalk - Notify SUCCESS
        if: ${{ success() }}
        env:
          ACCESS_TOKEN: ${{ steps.kakao-start.outputs.ACCESS_TOKEN }}
        run: |
          MSG_TITLE="âœ… DEV ë°°í¬ ì„±ê³µ"
          MSG_DESC="image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:dev-${GITHUB_SHA::7}\nrun: ${GITHUB_RUN_NUMBER}"
          TEMPLATE=$(jq -nc --arg t "$MSG_TITLE" --arg d "$MSG_DESC" \
            '{object_type:"text", text:($t+"\n"+$d), link:{web_url:"https://github.com/'"${GITHUB_REPOSITORY}"'/actions/runs/'"${GITHUB_RUN_ID}"'", mobile_web_url:"https://github.com/'"${GITHUB_REPOSITORY}"'/actions/runs/'"${GITHUB_RUN_ID}"'"}, button_title:"ë¡œê·¸ ë³´ê¸°"}')

          curl -s -X POST "https://kapi.kakao.com/v2/api/talk/memo/default/send" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            --data-urlencode "template_object=${TEMPLATE}" >/dev/null

      # === Kakao: FAILURE ===
      - name: KakaoTalk - Notify FAILURE
        if: ${{ failure() }}
        env:
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          KAKAO_REFRESH_TOKEN: ${{ secrets.KAKAO_REFRESH_TOKEN }}
        run: |
          ACCESS_TOKEN=$(curl -s -X POST https://kauth.kakao.com/oauth/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=refresh_token&client_id=${KAKAO_REST_API_KEY}&refresh_token=${KAKAO_REFRESH_TOKEN}" \
            | jq -r '.access_token')

          MSG_TITLE="âŒ DEV ë°°í¬ ì‹¤íŒ¨"
          MSG_DESC="repo: ${GITHUB_REPOSITORY}\nbranch: ${GITHUB_REF_NAME}\ncommit: ${GITHUB_SHA::7}"
          TEMPLATE=$(jq -nc --arg t "$MSG_TITLE" --arg d "$MSG_DESC" \
            '{object_type:"text", text:($t+"\n"+$d), link:{web_url:"https://github.com/'"${GITHUB_REPOSITORY}"'/actions/runs/'"${GITHUB_RUN_ID}"'", mobile_web_url:"https://github.com/'"${GITHUB_REPOSITORY}"'/actions/runs/'"${GITHUB_RUN_ID}"'"}, button_title:"ì—ëŸ¬ ë¡œê·¸"}')

          curl -s -X POST "https://kapi.kakao.com/v2/api/talk/memo/default/send" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            --data-urlencode "template_object=${TEMPLATE}" >/dev/null
