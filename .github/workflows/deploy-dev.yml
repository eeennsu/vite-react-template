name: Deploy to Amazon ECR

on:
  push:
    branches: ['dev', 'beta', 'main']

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: vite-react-template
  COMMIT_AUTHOR: ${{ github.event.head_commit.author.name || github.actor }}

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Determine environment
        run: |
          BRANCH_NAME=${{ github.ref_name }}
          if [ "$BRANCH_NAME" == "dev" ]; then
            echo "BUILD_ENV=development" >> $GITHUB_ENV
            echo "NOTIFY_PREFIX=DEV" >> $GITHUB_ENV
          elif [ "$BRANCH_NAME" == "beta" ]; then
            echo "BUILD_ENV=beta" >> $GITHUB_ENV
            echo "NOTIFY_PREFIX=BETA" >> $GITHUB_ENV
          elif [ "$BRANCH_NAME" == "main" ]; then
            echo "BUILD_ENV=production" >> $GITHUB_ENV
            echo "NOTIFY_PREFIX=PROD" >> $GITHUB_ENV
          fi

      # === Kakao: START ===
      - name: KakaoTalk - Notify START
        id: kakao-start
        env:
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          KAKAO_REFRESH_TOKEN: ${{ secrets.KAKAO_REFRESH_TOKEN }}
        run: |
          START_TS=$(date +%s)
          ACCESS_TOKEN=$(curl -s -X POST https://kauth.kakao.com/oauth/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=refresh_token&client_id=${KAKAO_REST_API_KEY}&refresh_token=${KAKAO_REFRESH_TOKEN}" | jq -r '.access_token')
          if [ -z "${ACCESS_TOKEN}" ] || [ "${ACCESS_TOKEN}" = "null" ]; then
            echo "Failed to get Kakao access token"; exit 1
          fi
          { echo "ACCESS_TOKEN=${ACCESS_TOKEN}"; echo "START_TS=${START_TS}"; } >> "$GITHUB_OUTPUT"

          TEMPLATE=$(jq -nc \
              --arg prefix "$NOTIFY_PREFIX" --arg repo "$GITHUB_REPOSITORY" \
              --arg branch "$GITHUB_REF_NAME" --arg commit "${GITHUB_SHA::7}" \
              --arg author "$COMMIT_AUTHOR" \
              '{object_type:"text", text:("[" + $prefix + "]" + " ðŸš€ ë°°í¬ ì‹œìž‘" + "\në ˆí¬ì§€í† ë¦¬: " + $repo + "\në¸Œëžœì¹˜: " + $branch + "\nì»¤ë°‹: " + $commit + "\nìž‘ì„±ìž: " + $author), link:{web_url:"https://github.com/'"${GITHUB_REPOSITORY}"'/actions/runs/'"${GITHUB_RUN_ID}"'"}, button_title:"ìžì„¸ížˆ"}')

          curl -s -X POST "https://kapi.kakao.com/v2/api/talk/memo/default/send" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            --data-urlencode "template_object=${TEMPLATE}" >/dev/null

      - name: Generate version tag
        id: version
        run: |
          DATETIME=$(date +'%Y%m%d-%H%M%S')
          COMMIT_HASH=$(git rev-parse --short HEAD)
          # BUILD_ENV ë³€ìˆ˜ì™€ ì¡°í•©í•˜ì—¬ ìµœì¢… íƒœê·¸ ìƒì„±
          VERSION_TAG="${{ env.BUILD_ENV }}-${DATETIME}-${COMMIT_HASH}"
          # stepì˜ outputìœ¼ë¡œ ì €ìž¥í•˜ì—¬ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš©
          echo "IMAGE_TAG=${VERSION_TAG}" >> "$GITHUB_OUTPUT"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build-push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.version.outputs.IMAGE_TAG }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.BUILD_ENV }}-latest

      # === Kakao: SUCCESS ===
      - name: KakaoTalk - Notify SUCCESS
        if: ${{ success() }}
        env:
          ACCESS_TOKEN: ${{ steps.kakao-start.outputs.ACCESS_TOKEN }}
          START_TS: ${{ steps.kakao-start.outputs.START_TS }}
        run: |
          END_TS=$(date +%s)
          ELAPSED=$(( END_TS - START_TS ))
          DURATION=$(printf "%dm %02ds" "$(( ELAPSED / 60 ))" "$(( ELAPSED % 60 ))")
          IMAGE="${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.version.outputs.IMAGE_TAG }}"

          TEMPLATE=$(jq -nc \
              --arg prefix "$NOTIFY_PREFIX" \
              --arg repo "$GITHUB_REPOSITORY" --arg branch "$GITHUB_REF_NAME" \
              --arg commit "${GITHUB_SHA::7}" --arg author "$COMMIT_AUTHOR" \
              --arg img "$IMAGE" --arg run "$GITHUB_RUN_NUMBER" --arg dur "$DURATION" \
              '{object_type:"text", text:("[" + $prefix + "]" + " âœ…  ë°°í¬ ì„±ê³µ" + "\në ˆí¬ì§€í† ë¦¬: " + $repo + "\në¸Œëžœì¹˜: " + $branch + "\nì»¤ë°‹: " + $commit + "\nìž‘ì„±ìž: " + $author + "\nì´ë¯¸ì§€: " + $img + "\nrun: " + $run + "\nâ± ê²½ê³¼: " + $dur), link:{web_url:"https://github.com/'"${GITHUB_REPOSITORY}"'/actions/runs/'"${GITHUB_RUN_ID}"'"}, button_title:"ë¡œê·¸ ë³´ê¸°"}')

          curl -s -X POST "https://kapi.kakao.com/v2/api/talk/memo/default/send" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            --data-urlencode "template_object=${TEMPLATE}" >/dev/null

      # === Kakao: FAILURE ===
      # [ìˆ˜ì •] ì‹¤íŒ¨ ì•Œë¦¼ ë©”ì‹œì§€ë¥¼ ë™ì ìœ¼ë¡œ ë³€ê²½
      - name: KakaoTalk - Notify FAILURE
        if: ${{ failure() }}
        env:
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          KAKAO_REFRESH_TOKEN: ${{ secrets.KAKAO_REFRESH_TOKEN }}
          START_TS: ${{ steps.kakao-start.outputs.START_TS }}
        run: |
          ACCESS_TOKEN=$(curl -s -X POST https://kauth.kakao.com/oauth/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=refresh_token&client_id=${KAKAO_REST_API_KEY}&refresh_token=${KAKAO_REFRESH_TOKEN}" | jq -r '.access_token')
          END_TS=$(date +%s)
          ELAPSED=$(( END_TS - START_TS ))
          DURATION=$(printf "%dm %02ds" "$(( ELAPSED / 60 ))" "$(( ELAPSED % 60 ))")

          TEMPLATE=$(jq -nc \
              --arg prefix "$NOTIFY_PREFIX" \
              --arg repo "$GITHUB_REPOSITORY" --arg branch "$GITHUB_REF_NAME" \
              --arg commit "${GITHUB_SHA::7}" --arg author "$COMMIT_AUTHOR" \
              --arg dur "$DURATION" \
              '{object_type:"text", text:("[" + $prefix + "]" + " âŒ ë°°í¬ ì‹¤íŒ¨" + "\në ˆí¬ì§€í† ë¦¬: " + $repo + "\në¸Œëžœì¹˜: " + $branch + "\nì»¤ë°‹: " + $commit + "\nìž‘ì„±ìž: " + $author + "\nâ± ê²½ê³¼: " + $dur), link:{web_url:"https://github.com/'"${GITHUB_REPOSITORY}"'/actions/runs/'"${GITHUB_RUN_ID}"'"}, button_title:"ì—ëŸ¬ ë¡œê·¸"}')

          curl -s -X POST "https://kapi.kakao.com/v2/api/talk/memo/default/send" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            --data-urlencode "template_object=${TEMPLATE}" >/dev/null
